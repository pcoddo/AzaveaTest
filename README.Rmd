---
author: "Perry Oddo"
date: "March 10, 2017"
output: html_document
---
#Data Analysis Test

## Part 1: Conceptual Question
**This first question is conceptual and written responses are expected. For each item below, indicate whether the appropriate method would be classification or regression, and whether we are most interested in inference or prediction. Please include a written sentence or two explaining why you made this choice. Also, indidate what n and p are for each section.**  


**(a)** A dataset contains data for 350 manufacturing companies in Europe. The following variables are included in the data for each company: industry, number of employees, salary of the CEO, and total profit. **We are interested in learning which variables impact the CEO's salary.**

*test response*
  
**(b)** A market research company is hired to help a startup analyze their new product. **We want to know whether the product will be a success or failure.** Similar products exist on the market so the market research company gathers data on 31 similar products. The company records the following data points about each previously launched product: price of the product, competition price, marketing budget, ten other variables, and whether or not it succeeded or failed.

**(c)** Every week data is collected for the world stock market in 2012. The data points collected include the % change in the dollar, the % change in the market in the United States, the % change in the market in China, and the % change in the market in France. **We are interested in predicting the % change in the dollar in relation to the changes every week in the world stock markets.**



## Part 2: Applied Question
**For this second applied question you will develop several predictive models. These should be written in R or Python and the code should be submitted. The models will predict whether a car will get high or low gas mileage. The question will be based on the Cars_mileage data set that is a part of this repo.**

**(a)** Create a binary variable that represents whether the car's mpg is above or below its median. Above the median should be represented as 1. Name this variable **mpg_binary.**

```{r}

# Clear all variables
rm(list = ls())
graphics.off()

# Read read mileage data and remove incomplete variables (NA)
df = read.csv("Cars_mileage.csv", 
              header = T, 
              sep = ",", 
              na.strings = '?')

df = na.omit(df)

# Add variable for median mileage
df$binary_median = NA

# Apply binary classification
df$binary_median = sapply(1:length(df$mpg), function(x){
  
  if(df$mpg[x] >= median(df$mpg)){
    return(1)
    
  } else {
    
    return(0)
  }
  
})

```
  

**(b)** Which of the other variables seem most likely to be useful in predicting whether a car's mpg is above or below its median? **Describe your findings and submit visual representations of the relationship between mpg_binary and other variables.**

```{r, message=FALSE, warning=FALSE}

# Reclassify discrete categorical variables
cat_var = c("cylinders", "origin", "year", "name", "binary_median")
for(i in cat_var){
  df[,i] = as.factor(df[,i])
}

### Visualize variable relationships
# Load required packages
require(GGally)
require(ggplot2)

# Subset predictor variables to plot and save as new data frame
df_2 = subset(x = df, select = c("mpg", "cylinders", "displacement", "horsepower", "weight", "acceleration", "year", "binary_median"))

# Produce pairs plot
#png("Figures/Figure1_pairsPlot.png", width = 8, height = 5.5, units = 'in', res = 300)
f1 = ggpairs(df_2,
              mapping = ggplot2::aes(color = binary_median),
              upper = list(continuous = wrap("density", alpha = 0.5), combo = "box"),
              lower = list(continuous = wrap("points", alpha = 0.3), combo = wrap("dot", alpha = 0.4)),
              diag = list(continuous = wrap("densityDiag", alpha = 0.5)),
              title = "Figure 1. Vehicle variable pairs plot",
              legend = c(1,1)) +
  theme(legend.position = "right") 
f1
#dev.off()
```
  
![Figure1](https://github.com/pcoddo/AzaveaTest/blob/master/Figures/Figure1_pairsPlot.png)

*Figure 1 shows the pairwise, marginal density, and box-and-whisker plots for the selected predictor variables. I excluded categorical and nominal variables such as cylinders and names, and included vehicle year as a factor term. Because "binary_median" is a derivative of "mpg", it is not especially illustrative to include "mpg" as a predictive factor. I remove it from the variable list for further analysis.*

```{r}

# Remove mpg variable from data frame
df_2 = df_2[,2:ncol(df_2)]
```  
  
**(c)** Split the data into a training set and a test set.  
```{r}

# Randomize dataset by assigning indices random numbers
set.seed(90210)
rand = runif(nrow(df))
df_2 = df_2[order(rand),]

# Create test (n = 40) and training sets from data frame 
df_test = df_2[1:40,]
df_train = df_2[41:nrow(df),]
```
  
**(d)** Perform two of the following in order to predict mpg_binary:  

1. *K-nearest neighbor analysis:*
```{r, message=FALSE}

# Load library
require(class)

# Normalize variables to range from 0 to 1 to remove influence of variable ranges
# Create new normalized data frame for continuous predictor variables (columns 2:5)
normalize = function(x){
  return((x - min(x)) / (max(x) - min(x)))
}

df_test_continuous = data.frame(sapply(df_test[,2:5], normalize), df_test$binary_median)
df_train_continuous = data.frame(sapply(df_train[,2:5], normalize), df_train$binary_median)

colnames(df_test_continuous)[5] = "binary_median"
colnames(df_train_continuous)[5] = "binary_median"

# Confirm new data structure
print(summary(df_test_continuous))
print(summary(df_train_continuous))
```

```{r}

# Create data frames for target variable (binary_median) prediction
df_test_target = df_2[1:40, "binary_median"]
df_train_target = df_2[41:nrow(df), "binary_median"]

# Set k value
k = floor(sqrt(nrow(df)))

# Create model
knn_mod = knn(train = df_train_continuous, test = df_test_continuous, cl = df_train_target, k = k)
table(df_test_target, knn_mod)

# Create table to visualize model results
```
|                   |                 |        KNN model prediction|       |
|------------------:|----------------:|:---------------:|-----------------|
|                   |                 | 0: Below_median | 1: Above_median |
| **Original Data** | 0: Below_median | **24**          | 0               |
|                   | 1: Above_median | 0               | **16**          |  

  
2. *Decision Tree Analsis: CART*
```{r, message=F}
# Load library
require(rpart)
require(rpart.plot)

# Specify target variable
cart_mod <- rpart(binary_median ~., data = df_train, method = "class")

# Plot model results
#png("Figures/Figure2_TreeA.png", width = 4, height = 4, units = 'in', res = 300)
rpart.plot(cart_mod, type = 3, digits = 3, fallen.leaves = TRUE)
#dev.off()
```
  
![Figure2](https://github.com/pcoddo/AzaveaTest/blob/master/Figures/Figure2_TreeA.png)
*This looks wonky, let's try re-running the model by excluding the factor 'year' variable.  

```{r}
# Re-run CART model to exclude categorical variables
cart_mod2 <- rpart(binary_median ~., data = df_train_continuous)

# Plot new results
#png("Figures/Figure3_TreeB.png", width = 4, height = 4, units = 'in', res = 300)
rpart.plot(cart_mod2, type = 3, digits = 3, fallen.leaves = TRUE)
#dev.off()
```
  
![Figure3](https://github.com/pcoddo/AzaveaTest/blob/master/Figures/Figure3_TreeB.png)  

```{r}

# Predict test data based on trained model
cart_mod_test <- predict(cart_mod2, df_test_continuous, type = "class")
table(df_test_target, cart_mod_test)

# Create table to visualize model results
```
|                   |                 |       CART model prediction|      |
|------------------:|----------------:|:---------------:|-----------------|
|                   |                 | 0: Below_median | 1: Above_median |
| **Original Data** | 0: Below_median | **22**          | 2               |
|                   | 1: Above_median | 0               | **16**          |  
